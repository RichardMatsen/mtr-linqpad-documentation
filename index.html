<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Linqpad as a Data Migration Tool | Linqpad as a Data Migration Tool</title>
    <meta name="description" content="Linqpad as a Data Migration Tool">
    
    
    <link rel="preload" href="/mtr-linqpad-documentation/assets/css/styles.d0c156e8.css" as="style"><link rel="preload" href="/mtr-linqpad-documentation/assets/js/app.d0c156e8.js" as="script"><link rel="preload" href="/mtr-linqpad-documentation/assets/js/6.dc94b703.js" as="script"><link rel="preload" href="/mtr-linqpad-documentation/assets/css/4.styles.7db7aa9a.css" as="style"><link rel="preload" href="/mtr-linqpad-documentation/assets/js/4.7db7aa9a.js" as="script"><link rel="prefetch" href="/mtr-linqpad-documentation/assets/js/3.17217cc0.js"><link rel="prefetch" href="/mtr-linqpad-documentation/assets/css/1.styles.2fd62d5a.css"><link rel="prefetch" href="/mtr-linqpad-documentation/assets/js/1.2fd62d5a.js"><link rel="prefetch" href="/mtr-linqpad-documentation/assets/css/2.styles.cf409140.css"><link rel="prefetch" href="/mtr-linqpad-documentation/assets/js/2.cf409140.js"><link rel="prefetch" href="/mtr-linqpad-documentation/assets/js/5.eab41d80.js"><link rel="prefetch" href="/mtr-linqpad-documentation/assets/js/7.428e5a07.js"><link rel="prefetch" href="/mtr-linqpad-documentation/assets/js/8.e3931155.js"><link rel="prefetch" href="/mtr-linqpad-documentation/assets/js/9.d513a9cb.js">
    <link rel="stylesheet" href="/mtr-linqpad-documentation/assets/css/1.styles.2fd62d5a.css"><link rel="stylesheet" href="/mtr-linqpad-documentation/assets/css/2.styles.cf409140.css"><link rel="stylesheet" href="/mtr-linqpad-documentation/assets/css/styles.d0c156e8.css"><link rel="stylesheet" href="/mtr-linqpad-documentation/assets/css/4.styles.7db7aa9a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/mtr-linqpad-documentation/" class="home-link router-link-exact-active router-link-active"><!----> <span class="site-name">Linqpad as a Data Migration Tool</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/mtr-linqpad-documentation/" class="nav-link router-link-exact-active router-link-active">Overview</a></div><div class="nav-item"><a href="/mtr-linqpad-documentation/checking-code-tables.html" class="nav-link">Checking Batch-Load Spreadsheets</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/mtr-linqpad-documentation/" class="nav-link router-link-exact-active router-link-active">Overview</a></div><div class="nav-item"><a href="/mtr-linqpad-documentation/checking-code-tables.html" class="nav-link">Checking Batch-Load Spreadsheets</a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>Linqpad as a Data Migration Tool</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/mtr-linqpad-documentation/#linqpad-features" class="sidebar-link">Linqpad Features</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/mtr-linqpad-documentation/#the-application" class="sidebar-link">The Application</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/mtr-linqpad-documentation/#excel-workbooks-vs-linqpad" class="sidebar-link">Excel workbooks vs Linqpad</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/mtr-linqpad-documentation/#data-sources" class="sidebar-link">Data Sources</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mtr-linqpad-documentation/#odbc" class="sidebar-link">ODBC</a></li><li class="sidebar-sub-header"><a href="/mtr-linqpad-documentation/#csv-files" class="sidebar-link">CSV files</a></li></ul></li><li><a href="/mtr-linqpad-documentation/#outputs" class="sidebar-link">Outputs</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/mtr-linqpad-documentation/#example-query" class="sidebar-link">Example query</a><ul class="sidebar-sub-headers"></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="linqpad-as-a-data-migration-tool"><a href="#linqpad-as-a-data-migration-tool" aria-hidden="true" class="header-anchor">#</a> Linqpad as a Data Migration Tool</h1> <p>This project illustrates the use of Linqpad as a testing tool for a data migration project.</p> <h2 id="linqpad-features"><a href="#linqpad-features" aria-hidden="true" class="header-anchor">#</a> Linqpad Features</h2> <p><strong>Linq</strong> is a declarative language extension for processing data. It has a range of operators that can be composed to construct a specific data pipeline.</p> <p><strong>Linqpad</strong> is an environment for developing Linq queries interactively. As well as running Linq queries, it provides a variety of ways to access data, and a <strong>Dump()</strong> method to output results.</p> <p>Linqpad integrates well with .Net libraries, so additional functionality can be added using C#.</p> <h2 id="the-application"><a href="#the-application" aria-hidden="true" class="header-anchor">#</a> The Application</h2> <p>The Patient Administration System (PAS) being migrated was critical 24/7 and had to be switched over at night during a two hour window. The new system master data was built and tested iteratively over a period of a year.</p> <p>Transactional data from the old system was initially migrated weekly, then daily to the new system, and tested each run. This repetitive testing was the key to deciding when the new system was fit to go live.</p> <h2 id="excel-workbooks-vs-linqpad"><a href="#excel-workbooks-vs-linqpad" aria-hidden="true" class="header-anchor">#</a> Excel workbooks vs Linqpad</h2> <p>At the start of the project, Excel workbooks were used extensively to gather master data, query the databases, and to record test results.</p> <p>These workbooks had been well built during many previous projects, but had the following limitations</p> <ul><li><p>VBA is an out of date language with no support for set-based or declarative constructs.</p></li> <li><p>Bug fixing in Excel VBA could sometimes be very time consuming</p></li> <li><p>Data was handled in the sheet, so there are limitations on the number of rows</p></li> <li><p>Data set joins were more difficult to do in Excel (e.g vlookup).</p></li> <li><p>Conceptually, tests in Excel tend to be one-dimensional (focussed on the data in the sheet)</p></li> <li><p>Automation of the workbooks was clumsy and prone to errors</p></li></ul> <p>Linqpad as a vehicle for interactive c#  was introduced to try and add a degree of automation to the migration testing process.</p> <h2 id="data-sources"><a href="#data-sources" aria-hidden="true" class="header-anchor">#</a> Data Sources</h2> <h3 id="odbc"><a href="#odbc" aria-hidden="true" class="header-anchor">#</a> ODBC</h3> <p>For this project ODBC is used to access master data on new system build (multiple database instances). The ODBC driver is provided by DB vendor and installed per machine.</p> <p>The vendor driver was wrapped in the <strong>GenericOdbc</strong> C# dll to simplify usage.</p> <h4 id="odbc-runner-usage"><a href="#odbc-runner-usage" aria-hidden="true" class="header-anchor">#</a> <em>ODBC Runner Usage:</em></h4> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> env <span class="token operator">=</span> <span class="token string">&quot;InstanceName&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> connection <span class="token operator">=</span> <span class="token string">&quot;Dsn=&quot;</span> <span class="token operator">+</span> env<span class="token punctuation">;</span>
<span class="token keyword">var</span> runner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RunQuery</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> query <span class="token operator">=</span> <span class="token string">@&quot;
  SELECT ... FROM ...
&quot;</span><span class="token punctuation">;</span>
runner<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> results <span class="token operator">=</span> runner<span class="token punctuation">.</span>Result<span class="token punctuation">.</span>Tables<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  <span class="token punctuation">.</span><span class="token function">AsEnumerable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>row <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">new</span> <span class="token punctuation">{</span> 
    <span class="token comment">// map columns here, e.g</span>
    Id <span class="token operator">=</span> row<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="csv-files"><a href="#csv-files" aria-hidden="true" class="header-anchor">#</a> CSV files</h3> <p>The extract files to be tested are in CSV format. Most are quite large, and therefore are best scanned in streaming mode. This is done with StreamReader and the yield keyword.</p> <p>The reader is implemented as a static string extension method in Linqpad's MyExtensions file (which is compiled to a dll upon saving).</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyExtensions</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> IEnumerable<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token operator">&gt;</span> <span class="token function">ReadCsv</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">string</span> file<span class="token punctuation">,</span> <span class="token keyword">char</span> delim <span class="token operator">=</span> <span class="token string">'\t'</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">string</span> line<span class="token punctuation">;</span>
    <span class="token keyword">using</span><span class="token punctuation">(</span><span class="token class-name">StreamReader</span> reader <span class="token operator">=</span> File<span class="token punctuation">.</span><span class="token function">OpenText</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>line <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">ReadLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>delim <span class="token operator">==</span> <span class="token string">'\n'</span><span class="token punctuation">)</span> 
        <span class="token punctuation">{</span>
          <span class="token keyword">yield</span> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token generic-method"><span class="token function">List</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">var</span> data <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>delim<span class="token punctuation">)</span><span class="token punctuation">;</span>
          List<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> currentLine <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token generic-method"><span class="token function">List</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">yield</span> <span class="token keyword">return</span> currentLine<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="csv-reader-usage"><a href="#csv-reader-usage" aria-hidden="true" class="header-anchor">#</a> <em>CSV Reader Usage:</em></h4> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> lineNo <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> extractData <span class="token operator">=</span> <span class="token string">&quot;myExtractFilePath&quot;</span><span class="token punctuation">.</span><span class="token function">ReadCsv</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">Skip</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment">// skip header</span>
  <span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>r<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token punctuation">{</span>
      <span class="token comment">// Get line number for error reporting</span>
      LineNo <span class="token operator">=</span> lineNo<span class="token operator">++</span><span class="token punctuation">,</span>  
      <span class="token comment">// map columns here, e.g</span>
      Id <span class="token operator">=</span> r<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="outputs"><a href="#outputs" aria-hidden="true" class="header-anchor">#</a> Outputs</h2> <p>Linqpad has a utility function called <code>Dump()</code> which handles the formatting of query results nicely.</p> <p>To make the result permanent, an extension method <code>Dump2Html()</code> was added in MyExtensions, making use of <code>LINQPad.Util.CreateXhtmlWriter()</code> to grab the HTML produced by <code>Dump()</code>.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">static</span> T <span class="token generic-method"><span class="token function">Dump2Html</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
  <span class="token keyword">this</span> <span class="token class-name">T</span> o<span class="token punctuation">,</span>
  <span class="token keyword">string</span> title <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token keyword">string</span> path <span class="token operator">=</span> <span class="token string">@&quot;.\results&quot;</span><span class="token punctuation">,</span>
  <span class="token keyword">bool</span> timestamped <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">var</span> timestamp <span class="token operator">=</span> timestamped <span class="token operator">==</span> <span class="token keyword">true</span>
    <span class="token operator">?</span> <span class="token string">&quot; (&quot;</span> <span class="token operator">+</span> <span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">&quot;{0:dd MMM yyyy - HH.mm}&quot;</span><span class="token punctuation">,</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span>
    <span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> localUrl <span class="token operator">=</span> path <span class="token operator">+</span> <span class="token string">@&quot;\&quot; + title + timestamp + &quot;</span><span class="token punctuation">.</span>html&quot;<span class="token punctuation">;</span>
  
  <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token keyword">var</span> writer <span class="token operator">=</span> LINQPad<span class="token punctuation">.</span>Util<span class="token punctuation">.</span><span class="token function">CreateXhtmlWriter</span><span class="token punctuation">(</span><span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>title <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">var</span> titleHtml <span class="token operator">=</span> Util<span class="token punctuation">.</span><span class="token function">RawHtml</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;div style='color:green; font-weight: bold;'&gt;&quot;</span> 
        <span class="token operator">+</span> title <span class="token operator">+</span> <span class="token string">&quot;&lt;/div&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      writer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>titleHtml<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    writer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
    File<span class="token punctuation">.</span><span class="token function">WriteAllText</span><span class="token punctuation">(</span>localUrl<span class="token punctuation">,</span> writer<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> o<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This separates the running of the tests (which can be quite lengthy) from the viewing of the results.<br>
The html produced can be opened from the file manager, i.e without a server.</p> <h2 id="example-query"><a href="#example-query" aria-hidden="true" class="header-anchor">#</a> Example query</h2> <p>This query checks referential integrity between Inpatient records and the Waiting List records on Admission Number.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token comment">// IPWaitingLists vs Inpatients (AdmissionNo)</span>

<span class="token keyword">var</span> statusMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token operator">&lt;</span>CodeDesc<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">new</span> <span class="token class-name">CodeDesc</span> <span class="token punctuation">{</span> Code <span class="token operator">=</span> <span class="token string">&quot;A&quot;</span><span class="token punctuation">,</span> Desc <span class="token operator">=</span> <span class="token string">&quot;Admitted&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">CodeDesc</span> <span class="token punctuation">{</span> Code <span class="token operator">=</span> <span class="token string">&quot;L&quot;</span><span class="token punctuation">,</span> Desc <span class="token operator">=</span> <span class="token string">&quot;Listed&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">CodeDesc</span> <span class="token punctuation">{</span> Code <span class="token operator">=</span> <span class="token string">&quot;PRE&quot;</span><span class="token punctuation">,</span> Desc <span class="token operator">=</span> <span class="token string">&quot;Preadmission&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">CodeDesc</span> <span class="token punctuation">{</span> Code <span class="token operator">=</span> <span class="token string">&quot;R&quot;</span><span class="token punctuation">,</span> Desc <span class="token operator">=</span> <span class="token string">&quot;Removed&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">CodeDesc</span> <span class="token punctuation">{</span> Code <span class="token operator">=</span> <span class="token string">&quot;S&quot;</span><span class="token punctuation">,</span> Desc <span class="token operator">=</span> <span class="token string">&quot;Suspend&quot;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> folder <span class="token operator">=</span> <span class="token string">@&quot;F:\Extracts\&quot;;

// Load keys for Inpatient records
var parents = (folder + @&quot;</span>Inpatients<span class="token punctuation">.</span>txt&quot;<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ReadCsv</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>r<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">new</span> <span class="token punctuation">{</span> ID <span class="token operator">=</span> r<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> AdmissionNo <span class="token operator">=</span> r<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>   <span class="token comment">// extract key columns</span>
  <span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Load Waiting List records</span>
<span class="token keyword">var</span> children <span class="token operator">=</span> <span class="token punctuation">(</span>folder <span class="token operator">+</span> <span class="token string">@&quot;WaitingLists.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ReadCsv</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>r <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">new</span> <span class="token punctuation">{</span> ID <span class="token operator">=</span> r<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> WaitinglistNo <span class="token operator">=</span> r<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
    AdmissionNo <span class="token operator">=</span> r<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> WaitListStatus <span class="token operator">=</span> r<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> WaitListType <span class="token operator">=</span> r<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Left join the children to parents, also to statusMap</span>
<span class="token comment">// Select only those children without a parent</span>
<span class="token keyword">var</span> joined <span class="token operator">=</span>
  <span class="token keyword">from</span> c <span class="token keyword">in</span> children
  <span class="token keyword">join</span> p <span class="token keyword">in</span> parents
    on c<span class="token punctuation">.</span><span class="token class-name">AdmissionNo</span> equals p<span class="token punctuation">.</span><span class="token class-name">AdmissionNo</span> <span class="token keyword">into</span> j1  <span class="token comment">// join child and parent</span>
  <span class="token keyword">from</span> p <span class="token keyword">in</span> j1<span class="token punctuation">.</span><span class="token function">DefaultIfEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                    <span class="token comment">// left join</span>
  <span class="token keyword">join</span> s <span class="token keyword">in</span> statusMap
    on c<span class="token punctuation">.</span><span class="token class-name">WaitListStatus</span> equals s<span class="token punctuation">.</span><span class="token class-name">Code</span> <span class="token keyword">into</span> j2  <span class="token comment">// join to status code map</span>
  <span class="token keyword">from</span> s <span class="token keyword">in</span> j2<span class="token punctuation">.</span><span class="token function">DefaultIfEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token comment">// left join</span>
  <span class="token keyword">where</span> p <span class="token operator">==</span> <span class="token keyword">null</span>   <span class="token comment">// take orphans</span>
  <span class="token keyword">select</span> <span class="token keyword">new</span> <span class="token punctuation">{</span>
    c<span class="token punctuation">.</span>ID<span class="token punctuation">,</span>
    c<span class="token punctuation">.</span>WaitinglistNo<span class="token punctuation">,</span>
    c<span class="token punctuation">.</span>AdmissionNo<span class="token punctuation">,</span>
    WaitListStatus <span class="token operator">=</span> s <span class="token operator">==</span> <span class="token keyword">null</span>
      <span class="token operator">?</span> <span class="token string">&quot;&lt;&lt;Unknown code: &quot;</span> <span class="token operator">+</span> c<span class="token punctuation">.</span>WaitListStatus  <span class="token comment">// if status code not matched</span>
      <span class="token punctuation">:</span> s<span class="token punctuation">.</span>Desc <span class="token operator">+</span> <span class="token string">&quot; [&quot;</span> <span class="token operator">+</span> s<span class="token punctuation">.</span>Code <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">,</span>
    c<span class="token punctuation">.</span>WaitListType
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> title <span class="token operator">=</span> <span class="token string">&quot;IPWaitingLists (booked) vs Inpatients (AdmissionNo)&quot;</span><span class="token punctuation">;</span>
joined<span class="token punctuation">.</span><span class="token function">Count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Dump</span><span class="token punctuation">(</span><span class="token string">&quot;COUNT: &quot;</span> <span class="token operator">+</span> title<span class="token punctuation">)</span><span class="token punctuation">;</span>
joined
  <span class="token punctuation">.</span><span class="token function">Take</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">Dump</span><span class="token punctuation">(</span><span class="token string">&quot;Example 10 rows - &quot;</span> <span class="token operator">+</span> title<span class="token punctuation">)</span>       <span class="token comment">// to screen</span>
  <span class="token punctuation">.</span><span class="token function">Dump2Html</span><span class="token punctuation">(</span><span class="token string">&quot;Example 10 rows - &quot;</span> <span class="token operator">+</span> title<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// to results folder as HTML file</span>
</code></pre></div><div class="minimap-container" style="width:250px;" data-v-2a4488b2><div class="minimap" style="top:250px;zoom:25%;" data-v-2a4488b2><div data-v-2a4488b2></div></div></div></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/mtr-linqpad-documentation/assets/js/6.dc94b703.js" defer></script><script src="/mtr-linqpad-documentation/assets/js/4.7db7aa9a.js" defer></script><script src="/mtr-linqpad-documentation/assets/js/app.d0c156e8.js" defer></script>
  </body>
</html>
